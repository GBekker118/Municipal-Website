@model PROG7312_POE.Models.EventsAndAnnouncements
<style>
    /* Background image */
    body {
        background-image: url('/img/slide2.jpg');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        margin: 0;
        padding: 0;
    }

    /* Make both tabs blue */
    .btn-tab {
        background-color: #0d6efd; 
        color: white !important;
        border: 2px solid white !important;
        box-shadow: none !important;
    }

    /* Hover effect */
    .btn-tab:hover {
        background-color: #0b5ed7;
        color: white !important;
        border: 2px solid white !important;
    }

    /* Active tab */
    .btn-tab.active,
    .btn-tab:focus,
    .btn-tab:active {
        background-color: #084298 !important;
        color: white !important;
        border: 2px solid white !important;
        box-shadow: none !important;
    }

    .btn-circle {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid white; 
        background-color: #0d6efd; 
        color: white; 
        font-weight: bold;
        font-size: 20px;
        line-height: 1;
    }

    input[name="search"]::placeholder {
        color: black;
    }

    .event-card {
        cursor: pointer; 
        transition: transform 0.2s, box-shadow 0.2s;
        width: 100%; 
        box-sizing: border-box;
    }

    .announcement-card {
        display: flex;
        padding: 0;
        border: none; 
        border-radius: 10px;
        overflow: hidden;
        box-shadow: none; 
        max-width: 58vw;
    }

    .announcement-logo {
        width: 150px;
        background-color: #13BB6C;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        padding: 10px;
    }

    .announcement-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover; 
        display: block;
        margin: 0; 
        padding: 0; 
        border-radius: 0;
    }

    .announcement-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between; 
        height: 100%;
    }

    .announcement-content p.card-text {
        display: -webkit-box;        
        -webkit-line-clamp: 2;    
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        margin: 0;
        min-height: 3em;             
    }
</style>

@{
    ViewData["Title"] = "All Events";
    // Retrieve the active tab (events or announcements) from ViewBag
    var activeTab = ViewBag.ActiveTab as string ?? "events";

    // Retrieve current search and filter values from ViewBag
    var searchQuery = ViewBag.SearchQuery as string ?? "";
    var selectedCategory = ViewBag.SelectedCategory as string ?? "";
    var selectedLocation = ViewBag.SelectedLocation as string ?? "";

    // Retrieve filter dropdown options from ViewBag
    var categories = ViewBag.Categories as IEnumerable<string> ?? new List<string>();
    var locations = ViewBag.Locations as IEnumerable<string> ?? new List<string>();
    var dates = ViewBag.Dates as IEnumerable<DateTime> ?? new List<DateTime>();
}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- LEFT: Search/Filter -->
        <div class="col-md-3">
            <div class="p-4 bg-primary text-white rounded shadow" style="min-height:80vh;">
                <!-- Tab Buttons for switching between Events and Announcements -->
                <div class="d-flex justify-content-center mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" id="eventsTab" class="btn btn-tab @(activeTab=="events"?"active":"")">Events</button>
                        <button type="button" id="announcementsTab" class="btn btn-tab @(activeTab=="announcements"?"active":"")">Announcements</button>
                    </div>
                </div>

                <!-- Header showing the current search -->
                <h4 class="mb-3 text-center">Find @((activeTab=="events")?"an Event":"an Announcement")</h4>

                <!-- Search and Filter Form -->
                <form method="get" asp-action="EventIndex" class="d-flex flex-column gap-3" id="filterForm">
                    <!-- Hidden field to track the active tab -->
                    <input type="hidden" id="activeTab" name="activeTab" value="@activeTab" />

                    <!-- Search input for title -->
                    <input style="margin-bottom: 10px;" type="text" name="search" placeholder="@(activeTab == "events" ? "Event Name" : "Announcement Name")" value="@searchQuery" class="form-control" />

                    <!-- Category filter dropdown -->
                    <select style="margin-bottom: 10px;" name="categoryFilter" class="form-select">
                        <option value="">Select a Category</option>
                        @foreach (var cat in categories)
                        {
                            if (cat == selectedCategory)
                            {
                                <option value="@cat" selected>@cat</option>
                            }
                            else
                            {
                                <option value="@cat">@cat</option>
                            }
                        }
                    </select>

                    <!-- Location filter dropdown -->
                    <select style="margin-bottom: 10px;" name="locationFilter" class="form-select">
                        <option value="">Select a Location</option>
                        @foreach (var loc in locations)
                        {
                            if (loc == selectedLocation)
                            {
                                <option value="@loc" selected>@loc</option>
                            }
                            else
                            {
                                <option value="@loc">@loc</option>
                            }
                        }
                    </select>
                    
                    <!-- Date filters -->
                    <!-- Start Date Filter -->
                    <input style="margin-bottom: 10px;" type="date" name="startDateFilter" placeholder="Start Date" value="@ViewBag.StartDateFilter" class="form-control" />

                    <!-- End Date Filter -->
                    <input style="margin-bottom: 10px;" type="date" name="endDateFilter" placeholder="End Date" value="@ViewBag.EndDateFilter" class="form-control" />

                    <!-- Suggested Categories for recent user selections (only for events tab) -->
                    @if (activeTab == "events" && categories.Any())
                    {
                        @if (ViewBag.SuggestedCategories != null && ((List<string>)ViewBag.SuggestedCategories).Any())
                        {
                            <select style ="margin-bottom: 10px;" id="suggestedCategories" class="form-select" onchange="if(this.value) window.location.href=this.value">
                                <option value="">Recommended Categories </option>
                                @foreach (var cat in (List<string>)ViewBag.SuggestedCategories)
                                {
                                    <option value="@Url.Action("EventIndex", "Events", new { categoryFilter = cat, activeTab = activeTab })">
                                        @cat
                                    </option>
                                }
                            </select>
                        }
                    }

                    <!-- Submit and Refresh button for search/filter -->
                    <div style="margin-bottom: 10px;" class="d-flex gap-2">
                        <button type="submit" class="btn btn-light" style="width:20vw;">Search / Filter</button>

                        <button type="button" class="btn btn-secondary" id="refreshBtn" style="background-color:#0d6efd; border: 2px solid white; border-radius:100px">
                            <i class="fa fa-refresh" style="padding:0;font-size:18px"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- RIGHT: Events or Announcements Cards -->
        <div class="col-md-9" style="background: rgba(0,0,0,0.6); padding:20px; border-radius:10px;">

            <!-- Button to create new Event or Announcement -->
            <div class="mb-3 text-end">
                <a id="createBtn" class="btn btn-primary d-flex align-items-center gap-2"
                   href="@Url.Action(activeTab == "events" ? "CreateEvent" : "CreateAnnouncement", "Events")">
                    <span class="btn-circle">+</span>
                    Create New @(activeTab == "events" ? "Event" : "Announcement")
                </a>
            </div>

            <!-- Scrollable area for the cards -->
            <div style="max-height:90vh; overflow-y:auto;">
                <!-- Display Events cards -->
                @if(activeTab=="events")
                {
                    <div>
                        @if(!Model.Events.Any())
                        {
                            <!-- Show message if no events exist -->
                            <div class="alert alert-info text-center">No Events Yet.</div>
                        }
                        else
                        {
                            <div class="row g-3" style="margin-right: 0; margin-left: 0;">
                                @foreach (var evt in Model.Events)
                                {
                                    <div class="col-md-6">
                                        <div class="card shadow-sm h-100 event-card position-relative"
                                             data-event-id="@evt.EventId"
                                             data-overview-url="@Url.Action("EventOverview", "Events", new { id = evt.EventId })">

                                            <!-- Priority / Views in top-right corner -->
                                                <span class="position-absolute top-0 end-0 m-2 badge text-light d-flex align-items-center" style="background-color:#049854; gap: 4px; font-size:15px">
                                                <i class="fa fa-eye"></i> @evt.Priority
                                            </span>

                                            <!-- Event Image -->
                                            @if (!string.IsNullOrEmpty(evt.Media))
                                            {
                                                <img src="@evt.Media" class="card-img-top" style="height:50%; object-fit:cover;" alt="Event Media" />
                                            }

                                            <div class="card-body d-flex flex-column">
                                                <!-- Title and Category side by side -->
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="card-title mb-0">@evt.EventTitle</h5>
                                                    <span class="badge bg-primary">@evt.Category</span>
                                                </div>

                                                <!-- Location -->
                                                <p class="mb-2"><strong>Location:</strong> @evt.Location</p>

                                                <!-- Description -->
                                                <p class="card-text flex-grow-1">@evt.EventDescription</p>

                                                <!-- Date -->
                                                <div class="d-flex justify-content-between align-items-center mt-2">
                                                    <p class="mb-0"><strong>Date:</strong> @evt.EventStartDate.ToString("dd MMM yyyy") -  @evt.EventEndDate.ToString("dd MMM yyyy")</p>
                                                
                                                    <p class="mb-0"><strong>Posted:</strong> @evt.Date.ToString("dd MMM yyyy")</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }

                // Display Announcements cards 
                else
                {
                    <div>
                        @if(!Model.Announcements.Any())
                        {
                            <!-- Show message if no announcements exist -->
                            <div class="alert alert-info text-center">No Announcements Yet.</div>
                        }
                        else
                        {
                            <div class="d-flex flex-column gap-3">
                                @foreach(var ann in Model.Announcements)
                                {
                                    <div class="card shadow-sm announcement-card">
                                        <div class="d-flex" style="gap:10px;">
                                            <!-- Left: Logo/Image -->
                                            <div class="announcement-logo flex-shrink-0">
                                                <img src="/img/notifs.png" alt="Announcement Logo">
                                            </div>

                                            <!-- Right: Content -->
                                            <div class="flex-grow-1 p-2 announcement-content">
                                                <h3 class="card-title mb-1">@ann.AnnouncementTitle</h3>
                                                <p class="card-text mb-1">@ann.AnnouncementMessage</p>
                                                <div>

                                                    <div class="d-flex gap-3">
                                                    @if (!string.IsNullOrEmpty(ann.AnnouncementLocation))
                                                    {
                                                        <p class="mb-0"><strong>Location:</strong> @ann.AnnouncementLocation</p>
                                                    }
                                                    @if (!string.IsNullOrEmpty(ann.AnnouncementCategory))
                                                    {
                                                        <p class="mb-0"><strong>Category:</strong> @ann.AnnouncementCategory</p>
                                                    }

                                                    </div>
                                                    <p class="mb-0"><strong>Date Posted:</strong> @ann.Date.ToString("dd MMM yyyy")</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
    <br />
</div>

<!-- JavaScript to switch tabs and reset filters -->
<script>
    const eventsTab = document.getElementById('eventsTab');
    const announcementsTab = document.getElementById('announcementsTab');
    const createBtn = document.getElementById('createBtn');
    const filterForm = document.getElementById('filterForm');

    function setActive(tab) {
        const form = document.getElementById('filterForm');
        document.getElementById('activeTab').value = tab;

        // Reset all filters when switching tabs
        document.querySelector('input[name="search"]').value = '';
        document.querySelector('select[name="categoryFilter"]').value = '';
        document.querySelector('select[name="locationFilter"]').value = '';
        document.querySelector('input[name="startDateFilter"]').value = '';
        document.querySelector('input[name="endDateFilter"]').value = '';

        // Reload page with new activeTab
        form.submit();
    }

    // Add click events to tab buttons
    eventsTab.addEventListener('click', ()=> setActive("events"));
    announcementsTab.addEventListener('click', ()=> setActive("announcements"));
</script>

<!-- JavaScript to handle clicking on an event card -->
<script>
    document.querySelectorAll('.event-card').forEach(card => {
        card.addEventListener('click', () => {
            const eventId = card.getAttribute('data-event-id');
            const overviewUrl = card.getAttribute('data-overview-url');

            // Call IncreasePriority method to increase event priority, then navigate to EventOverview
            fetch(`@Url.Action("IncreasePriority", "Events")?id=${eventId}`)
                .then(response => {
                    // Navigate to EventOverview after priority is increased
                    window.location.href = overviewUrl;
                });
        });
    });
</script>

<!-- JavaScript to refresh the tabs content -->
<script>
    const refreshBtn = document.getElementById('refreshBtn');

    refreshBtn.addEventListener('click', () => {
        // Reset all input fields
        document.querySelector('input[name="search"]').value = '';
        document.querySelector('select[name="categoryFilter"]').value = '';
        document.querySelector('select[name="locationFilter"]').value = '';
        document.querySelector('input[name="startDateFilter"]').value = '';
        document.querySelector('input[name="endDateFilter"]').value = '';

        // Reset active tab hidden input
        document.getElementById('activeTab').value = '@activeTab';

        // Reload page
        document.getElementById('filterForm').submit();
    });
</script>

<!-- Import SweetAlert2 library for displaying success and error popup messages -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Success Popup -->
@if (TempData["Message"] != null)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            Swal.fire({
                icon: "success",
                title: "Success!",
                text: "@TempData["Message"]",
                showConfirmButton: false,
                timer: 2500
            });
        });
    </script>
}
<!-- Error Popup -->
@if (TempData["Error"] != null)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            Swal.fire({
                icon: "error",
                title: "Error!",
                text: "@TempData["Error"]",
                showConfirmButton: true
            });
        });
    </script>
}

<!-- References:

    W3Schools (2019). How To Create Tabs. [online] W3schools.com. Available at: https://www.w3schools.com/howto/howto_js_tabs.asp.
    dcode (2019). How to Create Switchable Tabs - HTML, CSS & JavaScript Tutorial. [online] YouTube. Available at: https://www.youtube.com/watch?v=Ay93z3mZuh8.
    W3Schools (n.d.). JavaScript DOM EventListener. [online] www.w3schools.com. Available at: https://www.w3schools.com/js/js_htmldom_eventlistener.asp.
    Go Make Things (2023). Listening to multiple events on one element with JavaScript. [online] YouTube. Available at: https://www.youtube.com/watch?v=U8YhKQPYct4.
    ‌Aguilar, M. (2023). How to show a message in Sweet Alert after the execution of a submit button in ASP.NET MVC? [online] Stack Overflow. Available at: https://stackoverflow.com/questions/75362661/how-to-show-a-message-in-sweet-alert-after-the-execution-of-a-submit-button-in-a.

-->